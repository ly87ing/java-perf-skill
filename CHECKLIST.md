# 高并发系统优化审查检查清单

适用语言: Java / Go / Python / Node.js 等

---

## 1. 并发安全检查

### 1.1 原子性
- [ ] 临界区是否完整保护 (锁、synchronized、mutex)
- [ ] 复合操作是否原子 (检查-执行、读-改-写)
- [ ] 锁内是否有耗时操作 (应移到锁外)
- [ ] CAS 操作是否正确处理失败重试

### 1.2 可见性
- [ ] 共享变量是否正确同步 (volatile/atomic/channel)
- [ ] 双重检查锁是否正确实现 (对象封装)

### 1.3 竞态条件
- [ ] 惰性初始化是否线程安全
- [ ] 取消/中断操作返回值是否检查
- [ ] 集合迭代时是否可能被修改
- [ ] 先检查后执行是否原子

### 1.4 死锁
- [ ] 多锁场景顺序是否一致
- [ ] 是否有锁超时机制
- [ ] 是否有死锁检测

---

## 2. 锁竞争检查

### 2.1 锁粒度
- [ ] 锁保护范围是否过大
- [ ] 是否可以使用细粒度锁
- [ ] 热点数据是否需要锁分段

### 2.2 锁持有时间
- [ ] 锁内是否有 IO 操作
- [ ] 锁内是否有网络调用
- [ ] 是否可以提前计算再加锁

### 2.3 锁类型选择
- [ ] 读多写少是否使用读写锁
- [ ] 是否可以使用无锁数据结构
- [ ] 是否可以使用乐观锁

### 2.4 锁争用监控
- [ ] 是否监控锁等待时间
- [ ] 是否有锁争用告警

---

## 3. IO/网络异常检查

### 3.1 超时控制
- [ ] 所有 IO 操作是否有超时
- [ ] 连接超时是否设置
- [ ] 读写超时是否设置
- [ ] 全链路超时是否控制

### 3.2 重试机制
- [ ] 是否区分可重试/不可重试异常
- [ ] 是否使用指数退避
- [ ] 重试次数是否有上限
- [ ] 是否有重试风暴防护

### 3.3 熔断保护
- [ ] 是否有熔断器
- [ ] 熔断阈值是否合理
- [ ] 半开状态探测是否正确
- [ ] 熔断状态是否可观测

### 3.4 连接管理
- [ ] 连接池大小是否合理
- [ ] 连接是否有健康检查
- [ ] 空闲连接是否回收
- [ ] 连接泄露是否检测

### 3.5 资源释放
- [ ] finally/defer 是否关闭资源
- [ ] 异常路径是否释放资源
- [ ] 超时后资源是否释放

---

## 4. 消息积压检查

### 4.1 背压机制
- [ ] 是否有反向压力传递
- [ ] 生产者是否感知消费速度
- [ ] 是否支持阻塞/等待

### 4.2 队列管理
- [ ] 队列容量是否有上限
- [ ] 队列满时策略 (阻塞/丢弃/拒绝)
- [ ] 是否监控队列深度
- [ ] 是否有积压告警

### 4.3 消费能力
- [ ] 消费者是否可扩容
- [ ] 是否支持批量消费
- [ ] 是否支持并行消费
- [ ] 消费失败是否重试

### 4.4 优先级处理
- [ ] 是否支持消息优先级
- [ ] 是否可以丢弃低优先级
- [ ] 关键消息是否保证

---

## 5. 资源耗尽检查

### 5.1 线程池
- [ ] 最大线程数是否合理
- [ ] 队列大小是否有限
- [ ] 拒绝策略是否合理
- [ ] 是否监控活跃线程数

### 5.2 连接池
- [ ] 最大连接数是否限制
- [ ] 获取连接超时是否设置
- [ ] 连接池满是否告警

### 5.3 内存
- [ ] 缓存是否有大小限制
- [ ] 是否有内存使用监控
- [ ] OOM 前是否有降级

### 5.4 磁盘
- [ ] 日志是否有轮转
- [ ] 临时文件是否清理
- [ ] 磁盘满是否告警

### 5.5 资源突增防护 (短时间大批量创建)
- [ ] 是否有对象池复用
- [ ] 批量创建是否有速率限制
- [ ] 大对象是否复用而非每次创建
- [ ] 集合是否预分配容量
- [ ] 是否避免循环内创建对象
- [ ] 临时对象是否过多
- [ ] 字符串拼接是否使用 Builder
- [ ] 是否有内存突增告警
- [ ] GC 频率是否监控
- [ ] Young GC 时间是否过长

### 5.6 GC 压力优化
- [ ] 是否减少短命对象
- [ ] 大对象是否触发 Full GC
- [ ] 是否有对象逃逸分析
- [ ] 堆外内存是否使用 (DirectBuffer)
- [ ] 对象生命周期是否合理

---

## 6. 级联失败检查

### 6.1 依赖隔离
- [ ] 是否使用舱壁模式
- [ ] 不同依赖是否独立线程池
- [ ] 故障是否会扩散

### 6.2 失败传播
- [ ] 慢依赖是否会拖垮调用方
- [ ] 是否会引起雪崩
- [ ] 是否有快速失败机制

### 6.3 健康检查
- [ ] 依赖是否有探活
- [ ] 不健康依赖是否摘除
- [ ] 恢复后是否自动加回

---

## 7. 资源管理检查

### 7.1 线程/协程池
- [ ] 是否有关闭/清理方法
- [ ] 大小是否可配置
- [ ] 名称是否便于识别

### 7.2 连接池
- [ ] 连接是否正确归还
- [ ] 是否有泄露检测
- [ ] 关闭顺序是否正确

### 7.3 缓存
- [ ] 是否有过期策略 (TTL)
- [ ] 是否有淘汰策略 (LRU)
- [ ] 缓存穿透/雪崩防护

### 7.4 生命周期
- [ ] 组件销毁时资源是否释放
- [ ] 关闭顺序是否正确
- [ ] 优雅关闭是否支持

---

## 8. 可观测性检查

### 8.1 日志
- [ ] 级别是否合理
- [ ] 高频日志是否采样
- [ ] 格式是否结构化
- [ ] 异常是否有堆栈

### 8.2 指标
- [ ] 请求量/成功/失败分开统计
- [ ] 延迟有分位数 (P50/P99)
- [ ] 队列深度是否监控
- [ ] 资源使用率是否监控

### 8.3 告警
- [ ] 错误率告警
- [ ] 延迟告警
- [ ] 资源告警
- [ ] 熔断告警

---

## 9. 配置检查

### 9.1 参数校验
- [ ] 数值范围是否校验
- [ ] 无效配置是否有默认值
- [ ] 配置变更是否记录日志

### 9.2 动态配置
- [ ] 是否支持热更新
- [ ] 变更是否有审计

---

## 10. 文档检查

### 10.1 必须章节
- [ ] 问题背景 (数据)
- [ ] 核心架构 (流程图)
- [ ] 优化详解 (代码)
- [ ] 配置说明
- [ ] 监控告警
- [ ] 故障处理
- [ ] 压测方案

### 10.2 前置条件
- [ ] 依赖说明
- [ ] 环境要求
- [ ] 配置项说明

---

## 11. Actor 模式检查 (Akka/Erlang/Virtual Threads)

### 11.1 消息处理
- [ ] Actor 内是否有阻塞操作
- [ ] 消息处理是否幂等
- [ ] 消息顺序是否有保证要求
- [ ] 是否有消息丢失风险

### 11.2 Mailbox 管理
- [ ] Mailbox 是否有界
- [ ] Mailbox 满时策略 (丢弃/阻塞)
- [ ] 是否监控 Mailbox 深度
- [ ] 是否有积压告警

### 11.3 生命周期
- [ ] Actor 创建是否有成本
- [ ] Actor 是否有超时销毁
- [ ] 父 Actor 失败时子 Actor 处理
- [ ] Actor 重启策略是否合理

### 11.4 监督策略
- [ ] 子 Actor 失败如何处理
- [ ] 重启次数是否有限制
- [ ] 是否有升级策略 (Escalate)
- [ ] 故障是否隔离

---

## 12. 长连接管理检查 (WebSocket/SSE/gRPC Stream)

### 12.1 连接管理
- [ ] 最大连接数是否限制
- [ ] 连接是否有超时断开
- [ ] 异常连接是否清理
- [ ] 连接数是否监控

### 12.2 心跳检测
- [ ] 是否有心跳机制
- [ ] 心跳间隔是否合理
- [ ] 心跳超时如何处理
- [ ] 客户端/服务端双向心跳

### 12.3 重连机制
- [ ] 断连后是否自动重连
- [ ] 重连是否有指数退避
- [ ] 重连次数是否有上限
- [ ] 重连风暴是否防护

### 12.4 消息推送
- [ ] 推送失败如何处理
- [ ] 是否有消息确认机制
- [ ] 离线消息如何处理
- [ ] 推送是否有去重

### 12.5 广播优化
- [ ] 多用户相同消息是否复用
- [ ] 序列化是否只做一次
- [ ] 是否支持按房间/分组广播
- [ ] 大消息是否分片

### 12.6 会话管理
- [ ] 用户状态存储位置
- [ ] 会话超时是否清理
- [ ] 多端登录如何处理
- [ ] 会话恢复是否支持

---

## 语言特定检查

### Java
- [ ] synchronized vs ReentrantLock 选择
- [ ] ConcurrentHashMap.compute 内无阻塞
- [ ] CompletableFuture 异常处理
- [ ] @PreDestroy 资源关闭
- [ ] 线程池正确关闭

### Go
- [ ] goroutine 泄露检查
- [ ] channel 关闭正确
- [ ] context 超时传递
- [ ] defer 资源关闭
- [ ] sync.WaitGroup 使用正确

### Python
- [ ] GIL 影响考虑
- [ ] asyncio 正确使用
- [ ] 线程池/进程池正确关闭
- [ ] with 语句资源管理

### Node.js
- [ ] Promise 异常处理
- [ ] 事件监听器泄露
- [ ] 流背压处理
- [ ] 优雅关闭
